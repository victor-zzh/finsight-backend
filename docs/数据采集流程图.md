[开始: 运行 `main.py`]
       |
       v
[1. 初始化阶段 (Initialization)]
|
+---> [加载 .env 及 config.py 配置文件]
|      (数据: API密钥, DB连接串, LOOKBACK_DAYS, DB_BATCH_SIZE 等)
|
+---> [建立与 Tushare, Supabase, Qdrant 的服务连接]
|
+---> [记录脚本启动日志]
       |
       v
[2. 任务发现: 批量获取所有待办任务 (Batch Discovery)]
|
+---> [根据配置 (LOOKBACK_DAYS) 确定查询日期范围]
|
+---> **{调用 Tushare API: `notice()` (仅一次!)}**
|      (数据: 指定日期范围内 *所有公司* 的公告列表 `all_notices`)
|
+---> [在内存中筛选并过滤出所有新的财报公告]
|
+---> [检查 `documents` 表, 剔除已成功处理 (status='COMPLETED') 的公告]
|      (数据: 最终的、需要处理的财报任务列表 `pending_reports`)
       |
       v
<决策> 待办任务列表是否为空?
|
| (是) --> [记录日志: "无新任务"], [结束]
|
| (否)
v
[3. 核心处理循环 (Core Processing Loop) - 遍历待办任务]
|
| (对于每一个 `report` in `pending_reports`)
v
|
+---> [在 Supabase `documents` 表中 **UPSERT** 记录, status='PENDING']
|      (数据: document_id)
|
+---> [TRY-EXCEPT 错误处理块开始 (隔离单个报告的失败)]
       |
       v
       [3a. 定量数据处理 (Quantitative Data)]
       |
       +---> {调用 Tushare API: `income()`, `balance_sheet()`, `cashflow()`}
       |
       +---> [**UPSERT** 数据到 Supabase 的三张报表及 `financial_indicators` 表]
       |      (逻辑: ON CONFLICT DO UPDATE, 确保数据总是最新的)
       |
       v
       [3b. 定性数据处理 (Qualitative Data)]
       |
       +---> [下载财报PDF原文并上传至 Supabase Storage]
       |
       +---> [更新 `documents` 表, 记录 `storage_path`, status='PROCESSING']
       |
       +---> [解析PDF, 语义切块 (Chunking)]
       |      (数据: 文本块列表 `chunk_list`)
       |
       v
       [3c. **批量化**存储 RAG 数据 (Batch Store RAG Data)]
       |
       +---> [初始化空的 chunk/vector 批处理列表 (batches)]
       |
       +---> [遍历 `chunk_list`]
       |      |
       |      v
       |      [将 (chunk原文, 向量) 添加到批处理列表中]
       |      |
       |      v
       |      <决策> 批处理列表已满 (达到 DB_BATCH_SIZE) 或循环结束?
       |      |
       |      | (是)
       |      v
       |      [**批量写入** Supabase `chunks` 表]
       |
       +-----> [**批量写入** Qdrant Cloud] --> [清空批处理列表]
       |
       v
       [3d. 最终化 (Finalization)]
       |
       +---> [更新 `documents` 表, status='COMPLETED']
       |
       +---> [记录成功日志]
       |
       |
       +---- [EXCEPT: 如果TRY块中发生任何异常]
       |      |
       |      v
       |      [捕获异常, 记录详细错误日志]
       |
       +-----> [更新 `documents` 表, status='FAILED']
       |
+---> [TRY-EXCEPT 错误处理块结束]
|
+---> [继续下一个待办任务]
       |
       v
[所有待办任务遍历完毕]
       |
       v
[4. 结束阶段 (Conclusion)]
|
+---> [打印本次运行的执行摘要]
|
+---> [安全关闭所有数据库连接]
       |
       v
[结束]