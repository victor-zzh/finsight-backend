[用户在前端提交查询]
       |
       v
[Next.js后端 /api/analyze 接收请求]
       |
       v
[1. 意图分析 (Intent Analysis)]
|
+---> [组装"意图分析Prompt"]
|
+---> [调用 GLM (快速模型)]
|
+---> [接收并解析返回的 "执行蓝图" JSON]
       |
       v
<------> [决策: "执行蓝图"是否有效?] <------>
|      (status === "SUCCESS"?)         |
|                                      | (NO)
| (YES)                                v
|                             [向前端返回错误或澄清问题] -> [结束]
v
[2. 数据检索 (Data Retrieval) - 根据"意图"进行分发]
|
+------------------------------------------------------------------------------------------------+
|                                                                                                |
| <-----> [决策: intent 是什么?] <---------------------------------------------------------------+
| |                                |                               |                               |
| v (get_trend_analysis)           v (get_qualitative_insight)     v (compare_companies)           v (get_realtime_quote)
| |                                |                               |                               |
| |-> [并行查询]                     |-> [查询 Qdrant Cloud]           |-> [循环查询 PostgreSQL]     |-> [调用 Tushare/AKshare]
| |   |                              |   (根据问题语义检索原文片段)      |   (获取各公司的指定指标)      |   (获取实时行情数据)
| |   +-> [查询 PostgreSQL]          |                               |                               |
| |   |   (获取多年的财务指标)         |                               |                               |
| |   +-> [查询 Qdrant Cloud]        |                               |                               |
| |       (检索各年份的原因摘要)       |                               |                               |
| |                                |                               |                               |
| +------------+-------------------+-------------------------------+-------------------------------+
|              |
|              v
[3. 数据整合 (Data Aggregation)]
|
+---> [将所有从数据库/API获取的数据, 整合成一个结构化的输入JSON]
       |
       v
[4. 最终分析生成 (Final Synthesis)]
|
+---> [根据意图选择 "prompts.ts" 中的任务模板]
|
+---> [组装最终的、包含所有数据和指令的 "分析归纳Prompt"]
|
+---> [调用 GLM (强大模型)]
|
+---> [接收并格式化最终的分析报告JSON]
       |
       v
[Next.js后端向前端发送JSON响应]
       |
       v
[前端组件解析JSON并渲染成用户界面]
       |
       v
[结束]